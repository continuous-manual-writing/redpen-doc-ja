== RedPen を拡張する

ユーザは自身で RedPen を拡張（機能追加）できます。
本節では機能追加の方法と RedPen が内部に保持する文書モデルについて解説します。

機能拡張の作成には抽象クラス（Validator）を実装する必要があります。バージョン1.3以降、JavaScript でも拡張可能になっています。

[[extending-validators]]
=== Validator クラスの拡張

Validator クラスには実装できるメソッドがいくつか（validate ・ prevalidate ・ init）提供されています。
以下各メソッドについて解説します。

[[validate-methods]]
==== validate メソッド

機能を作成するには、かならず **validate** メソッドの実装が必要です。
validate メソッドには引数によっていくつかのバリエーションがあります。
現状では三種類の validate メソッドが提供されています。

[source,java]
----
include::validate-java-interfaces.txt[]
----

Note: 実装されたクラスは特定のパッケージに属す必要があります。利用できるパッケージは **cc.redpen.validator** ・ **cc.redpen.validator.sentence** ・ **cc.redpen.validator.section** です。

[[prevalidate-method]]
==== prevalidate メソッド

preValidate は validate が呼び出される前に実行されます。preValidate メソッドを validate メソッドの前処理として利用すると便利です。
現在、二種類の prevalidate メソッドが提供されています。

[source,java]
----
include::prevalidate-java-interfaces.txt[]
----

[[init-method]]
==== init メソッド

init メソッドは機能（Validator）用の設定項目（プロパティ）を読み込むのに使用します。

[source,java]
----
include::init-java-interfaces.txt[]
----

たとえば **SentencelengthValidator** は **max_len** というプロパティ（設定項目）を提供します。
max_len は入力文書で許される一文の最大長を指定します。以下は文の最大長を二百に指定した設定例となります。

[source,xml]
----
include::load-property-config.xml[]
----

SentenceLengthValidator は max_len の値を init メソッドで読み込みます。
実際の init 処理は、以下で定義されます。

[source,java]
----
include::init-java-implementation.txt[]
----

上記のコードで、 getConfigAttributeAsInt は max_len に指定した値を int 型としてロードしています。

[[adding-validators]]
=== 作成した Validator の追加

RedPen に作成した Validator を追加する方法は二通りあります。

一つは、機能拡張（Validator）用ファイルを、RedPen のソースに追加してビルドする方法です。
この方法は簡単です。しかし機能拡張のソースファイルを RedPen ソースファイル群と同梱して扱う必要があります。

もう一つの方法はプラグインを作る方法です。
プラグインの場合には、機能拡張ソースファイルを RedPen から独立して扱えます。

Note: どちらの方法でもファイル名に制約があります。ファイル名は語尾（サフィックス）、**Validator** で終わる必要があります。クラス名が Validator で終わらない場合、RedPen は実装された機能をロードできません。
以下、Validator を追加する方法とプラグインの作り方について解説します。

[[add-a-validator-in-redpen-source]]
==== Validator を RedPen のソースに追加

ではさっそく、簡単な Validator （PlainSentenceLengthValidator）を実装してみましょう。
PlainSentenceLengthValidator は文書内に存在する文が百文字もしくはそれ以上続く場合、エラーを出力します。
実装したのち、PlainSentenceLengthValidator を RedPen のソースに追加します。

[[sentencelengthvalidator]]
===== PlainSentenceLengthValidator

PlainSentenceLengthValidator クラスをパッケージ'cc.redpen.validator.sentence'に作成します。
このときクラスは 'redpen/redpen-core/src/main/java/cc/redpen/validator/sentence/' ディレクトリに保存します。

以下は PlainSentenceLengthValidator クラスの実装となります。

[source,java]
----
include::plainsentencelengthvalidator.java[]
----

PlainSentenceLengthValidator は validate （引数＝ Sentence オブジェクト）メソッドを実装しています。
PlainSentenceLengthValidator が設定ファイルに追加されると、RedPen は実装した validate メソッドを実行します。
Sentence が引数なので、RedPen は入力文書の文すべてを引数としてくりかえし実行します。

[[include-a-new-validator]]
===== 実装した Validator を適用する

では設定ファイルに作成した機能を追加しましょう。設定ファイルにはクラス名からサフィックス Validator をのぞいて追加します。
以下、PlainSentenceLengthValidator を設定に追加しています。

[source,xml]
----
include::extension-config.xml[]
----

[[create-a-validator-plugin]]
==== プラグインの作成

プラグイン作成でもっとも重要なファイルは pom.xml です。
pom.xml はビルドツール、Maven の設定ファイルです。以下は pom.xml の例です。

[source,java]
----
include::redpen-plugin-pom.xml[]
----

プラグインを作るときには上の pom.xml ファイルが**ほぼ**そのまま利用できます。
変更する点は **artifactId** 、**name** 要素です。あなたの機能名になるよう名前を変更しましょう。

これで pom.xml が編集できました。編集した機能用のファイルを"main/java/cc/redpen/validator/sentence" （sentence）にコピーします。
上記で解説しましたように、機能用のクラスは Validator クラスを継承する必要があります。

Validator の実装ファイルをコピーすると、ビルドができます。以下のコマンドでプラグインを作成しましょう。

[source,bash]
----
$ mvn install
----

[[including-a-user-defined-validator-plugin]]
===== 作成したプラグインを利用する

無事 mvn コマンドによるビルドが成功しました。これで **target** ディレクトリにプラグイン用 jar ファイルが生成されます。
プラグイン用 jar ファイルを RedPen のクラスパスが含まれるディレクトリ（$REDPEN_HOME/lib など）にコピーします。
作成したプラグインが設定ファイルに追加されると、RedPen は実装した validate メソッドを実行します。

[[extending-with-javascript]]
=== JavaScript による機能拡張の作成

バージョン1.3から JavaScript による機能拡張（**機能拡張スクリプト**）をサポートしています。機能拡張スクリプトの作成にあたってはビルド作業が必要ありません。そのためユーザはより気軽に RedPen を拡張できます。

機能拡張スクリプトはいくつかのメソッドを定義します。以下定義できるメソッド群を解説します。

==== validate 系メソッド

機能拡張スクリプトには、かならず **validate** 系メソッドの定義が一つ以上必要です。

定義できる validate 系メソッドは二種類（validateSentence ・ validateSection）存在します。

===== validateSentence メソッド

validateSentence は引数に文（Sentence）を持ちます。

===== validateSection メソッド

validateSection は引数に節（Section）をとります。文より大きな規模のチェックを行いたいときに使用します。

たとえば著しく類似した節を検知する機能 **DuplicatedSection** があります。

DuplicatedSection は節単位の検査を行ないます。節の検査に validateSection メソッドを利用します。

==== preValidate 系メソッド

機能拡張スクリプトで **preValidate** 系メソッドを定義すると、検査に先立って前処理ができます。
preValidate 系メソッドは引数によって二種類（preValidateSentence ・ preValidateSection）存在します。それぞれ対応する validate 系メソッド（validateSentence ・ validateSection）実行前に呼び出されます。

===== preValidateSentence メソッド

preValidateSentence は引数に文（Sentence）を持ちます。

===== preValidateSection メソッド

preValidateSection は引数に節（Section）を持ちます。

=== 作成した機能拡張スクリプトの利用

**JavaScript** 機能を有効にすると、機能拡張スクリプトが利用できます。JavaScript 機能はデフォルトで RedPen ホームディレクトリ直下の js ディレクトリを走査します。走査するディレクトリは<<properties-13, プロパティ>>で変更できます。

[source, xml]
----
include::redpen-js-conf.xml[]
----

[[model-structure]]
=== 文書モデル

本節では RedPen が内部に保持する文書モデルについて解説します。
RedPen は多様なテキストフォーマットをサポートします。
各種の入力文書は RedPen 内部で**文書モデル**というブロック（クラス）群に変換されます。

生成された内部文書モデルは以下のブロックからなります。

* *Document* 一つ以上の節を持つファイル
* *Section* 文書内の節に相当する。複数のブロック（見出し, パラグラフ, リスト）を保持する。
* *Header* 見出し文
* *Paragraph* パラグラフに相当（複数の文を保持する）
* *ListBlock* リスト要素（ListElement）を保持する

以下のイメージは RedPen が内部で使用する文書モデルです。

image::model.jpg[width="500", height="300"]
